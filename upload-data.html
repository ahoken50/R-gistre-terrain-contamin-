<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charger les donn√©es municipales - Val-d'Or</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-top: 30px;
        }
        .header-section {
            text-align: center;
            margin-bottom: 40px;
        }
        .header-section h1 {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .drop-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 30px 0;
            background: #f8f9ff;
        }
        .drop-zone:hover, .drop-zone.drag-over {
            background-color: #e7f3ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }
        .drop-zone h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        .data-preview {
            max-height: 500px;
            overflow: auto;
            margin: 30px 0;
            border: 1px solid #dee2e6;
            border-radius: 10px;
        }
        .btn-group-custom {
            margin: 30px 0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .btn-custom {
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .alert-custom {
            margin-top: 20px;
            border-radius: 10px;
            border: none;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .stats-card h3 {
            font-size: 2.5rem;
            margin: 0;
        }
        .stats-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading-spinner.active {
            display: block;
        }
        .format-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .firebase-status.connected {
            border-left: 4px solid #28a745;
        }
        .firebase-status.disconnected {
            border-left: 4px solid #dc3545;
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Statut Firebase -->
    <div id="firebaseStatus" class="firebase-status disconnected">
        <span id="statusIcon">üî¥</span>
        <span id="statusText">Connexion Firebase...</span>
    </div>

    <div class="container">
        <div class="header-section">
            <h1>üóÇÔ∏è Charger les Donn√©es Municipales dans Firebase</h1>
            <p class="lead">Importez votre fichier CSV ou Excel et chargez-le directement dans Firebase</p>
        </div>
        
        <hr>
        
        <!-- Zone de t√©l√©chargement -->
        <div class="drop-zone" id="dropZone">
            <h3>üìÅ Glissez-d√©posez votre fichier CSV ou Excel ici</h3>
            <p>ou cliquez pour s√©lectionner un fichier</p>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
        </div>
        
        <!-- Format attendu -->
        <div class="format-info">
            <h5>üìã Format requis :</h5>
            <p><strong>Colonnes attendues (dans cet ordre) :</strong></p>
            <code>adresse, lot, reference, avis_decontamination, bureau_publicite, commentaires</code>
            <p class="mt-3"><strong>Exemple CSV :</strong></p>
            <code>"1185, des Foreurs","2299001","7610-08-01-17124-06","","12223243","Terrain commercial"</code>
        </div>
        
        <!-- Mod√®le √† t√©l√©charger -->
        <div class="mb-3 text-center">
            <a href="#" id="downloadTemplate" class="btn btn-outline-primary btn-custom">
                üì• T√©l√©charger le mod√®le CSV
            </a>
        </div>
        
        <!-- Spinner de chargement -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-3"><strong>Chargement des donn√©es vers Firebase...</strong></p>
        </div>
        
        <!-- Aper√ßu des donn√©es -->
        <div id="previewSection" style="display: none;">
            <h4>üëÄ Aper√ßu des donn√©es</h4>
            
            <!-- Statistiques -->
            <div class="stats-card">
                <h3 id="recordCount">0</h3>
                <p>enregistrements charg√©s</p>
            </div>
            
            <div class="data-preview">
                <table class="table table-striped table-hover table-sm" id="previewTable">
                    <thead class="table-dark"></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- Boutons d'action -->
            <div class="btn-group-custom">
                <button id="uploadToFirebase" class="btn btn-success btn-custom">
                    üî• Charger dans Firebase
                </button>
                <button id="downloadJson" class="btn btn-info btn-custom">
                    üíæ T√©l√©charger JSON (backup)
                </button>
                <button id="cancelBtn" class="btn btn-secondary btn-custom">
                    ‚ùå Annuler
                </button>
            </div>
            
            <!-- Message de succ√®s -->
            <div class="alert alert-success alert-custom" id="successMessage" style="display: none;">
                <h5>‚úÖ Donn√©es charg√©es avec succ√®s dans Firebase !</h5>
                <p class="mb-0">Les donn√©es sont maintenant disponibles dans l'application.</p>
                <div class="mt-3">
                    <a href="index.html" class="btn btn-primary">
                        üöÄ Voir dans l'application
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Messages d'erreur -->
        <div id="errorSection" class="alert alert-danger alert-custom" style="display: none;"></div>
        
        <hr class="mt-5">
        
        <div class="text-center">
            <a href="index.html" class="btn btn-outline-secondary btn-custom">
                ‚Üê Retour √† l'application
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import Papa from 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm';
        import * as XLSX from 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCXkuOEHJ8RFz4st6ilEtxGWk5UtuWn8Gk",
            authDomain: "r-gistre-terrain-contamin.firebaseapp.com",
            projectId: "r-gistre-terrain-contamin",
            storageBucket: "r-gistre-terrain-contamin.firebasestorage.app",
            messagingSenderId: "501248384607",
            appId: "1:501248384607:web:6199f69d20a194639a45ea",
            measurementId: "G-5B5GYK1SHF"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Mettre √† jour le statut Firebase
        const firebaseStatus = document.getElementById('firebaseStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        
        firebaseStatus.classList.remove('disconnected');
        firebaseStatus.classList.add('connected');
        statusIcon.textContent = 'üü¢';
        statusText.textContent = 'Firebase connect√©';

        const REQUIRED_COLUMNS = [
            "adresse",
            "lot",
            "reference",
            "avis_decontamination",
            "bureau_publicite",
            "commentaires"
        ];

        let parsedData = [];

        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        const previewSection = document.getElementById("previewSection");
        const errorSection = document.getElementById("errorSection");
        const previewTable = document.getElementById("previewTable");
        const recordCount = document.getElementById("recordCount");
        const uploadToFirebaseBtn = document.getElementById("uploadToFirebase");
        const downloadJsonBtn = document.getElementById("downloadJson");
        const cancelBtn = document.getElementById("cancelBtn");
        const downloadTemplate = document.getElementById("downloadTemplate");
        const successMessage = document.getElementById("successMessage");
        const loadingSpinner = document.getElementById("loadingSpinner");

        function showError(message) {
            errorSection.innerHTML = `‚ùå ${message}`;
            errorSection.style.display = "block";
            previewSection.style.display = "none";
            successMessage.style.display = "none";
        }

        function clearError() {
            errorSection.style.display = "none";
        }

        function normaliseRecord(record) {
            const normalised = {};
            const sourceEntries = Object.entries(record ?? {});

            for (const [key, value] of sourceEntries) {
                const normalisedKey = key
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, "_")
                    .replace(/^_+|_+$/g, "");

                if (normalisedKey) {
                    normalised[normalisedKey] = value ?? "";
                }
            }

            for (const column of REQUIRED_COLUMNS) {
                if (!(column in normalised)) {
                    normalised[column] = "";
                }
            }

            return normalised;
        }

        function validateRecords(records) {
            if (!Array.isArray(records) || records.length === 0) {
                throw new Error("Le fichier ne contient aucune donn√©e exploitable.");
            }

            const normalisedRecords = records.map(normaliseRecord);

            const missingColumns = REQUIRED_COLUMNS.filter(
                (column) => !Object.prototype.hasOwnProperty.call(normalisedRecords[0], column)
            );

            if (missingColumns.length > 0) {
                throw new Error(
                    `Colonnes manquantes: ${missingColumns.join(", ")}.\nAssurez-vous que le fichier contient les en-t√™tes requis.`
                );
            }

            return normalisedRecords;
        }

        function displayPreview(records) {
            const headers = Object.keys(records[0]);
            const thead = previewTable.querySelector("thead");
            const tbody = previewTable.querySelector("tbody");

            thead.innerHTML = `<tr>${headers.map((h) => `<th>${h}</th>`).join("")}</tr>`;

            const sample = records.slice(0, 10);
            tbody.innerHTML = sample
                .map(
                    (row) =>
                        `<tr>${headers
                            .map((h) => `<td>${row[h] ?? ""}</td>`)
                            .join("")}</tr>`
                )
                .join("");

            if (records.length > 10) {
                tbody.innerHTML += `<tr><td colspan="${headers.length}" class="text-center text-muted"><em>... et ${records.length - 10} autres enregistrements</em></td></tr>`;
            }

            recordCount.textContent = records.length;
            previewSection.style.display = "block";
            successMessage.style.display = "none";
        }

        async function parseCsv(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete(result) {
                        if (result.errors?.length) {
                            reject(new Error(result.errors[0].message));
                            return;
                        }
                        resolve(result.data);
                    },
                    error(error) {
                        reject(error);
                    }
                });
            });
        }

        async function parseExcel(file) {
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: "array" });

            if (!workbook.SheetNames.length) {
                throw new Error("Le fichier Excel ne contient aucune feuille.");
            }

            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            return rows;
        }

        async function handleFile(file) {
            clearError();

            if (!file) {
                showError("Aucun fichier s√©lectionn√©.");
                return;
            }

            const extension = file.name.trim().toLowerCase().split(".").pop();

            try {
                let rawRecords;

                if (extension === "csv") {
                    rawRecords = await parseCsv(file);
                } else if (extension === "xlsx" || extension === "xls") {
                    rawRecords = await parseExcel(file);
                } else {
                    showError("Format non support√©. Utilisez un fichier CSV, XLS ou XLSX.");
                    return;
                }

                const validated = validateRecords(rawRecords);
                parsedData = validated;
                displayPreview(validated);
            } catch (error) {
                console.error(error);
                showError(`Erreur de lecture du fichier: ${error.message}`);
            }
        }

        function downloadFile(filename, content, mimeType = "application/octet-stream") {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement("a");
            anchor.href = url;
            anchor.download = filename;
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
            URL.revokeObjectURL(url);
        }

        // Charger dans Firebase
        uploadToFirebaseBtn.addEventListener("click", async () => {
            if (!parsedData.length) {
                showError("Aucune donn√©e √† charger.");
                return;
            }

            try {
                loadingSpinner.classList.add('active');
                uploadToFirebaseBtn.disabled = true;
                
                console.log('üî• Chargement des donn√©es dans Firebase...', parsedData.length, 'enregistrements');
                
                const docRef = doc(db, 'municipal_data', 'current');
                await setDoc(docRef, {
                    data: parsedData,
                    lastUpdate: new Date().toISOString(),
                    count: parsedData.length,
                    source: "Interface web de chargement"
                });
                
                console.log('‚úÖ Donn√©es charg√©es dans Firebase avec succ√®s!');
                
                loadingSpinner.classList.remove('active');
                successMessage.style.display = "block";
                
                // Scroll vers le message de succ√®s
                successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement dans Firebase:', error);
                loadingSpinner.classList.remove('active');
                uploadToFirebaseBtn.disabled = false;
                showError(`Erreur lors du chargement dans Firebase: ${error.message}`);
            }
        });

        // T√©l√©charger JSON (backup)
        downloadJsonBtn.addEventListener("click", () => {
            if (!parsedData.length) {
                showError("Aucune donn√©e √† exporter.");
                return;
            }

            const payload = {
                data: parsedData,
                metadata: {
                    source: "Registre municipal - Ville de Val-d'Or",
                    total_records: parsedData.length,
                    last_update: new Date().toISOString(),
                    generated_by: "Interface web de chargement"
                }
            };

            downloadFile("municipal-data.json", JSON.stringify(payload, null, 2), "application/json");
            
            // Afficher une notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                ‚úÖ Fichier JSON t√©l√©charg√© avec succ√®s !
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        });

        // T√©l√©charger le mod√®le
        downloadTemplate.addEventListener("click", (event) => {
            event.preventDefault();
            const template = `adresse,lot,reference,avis_decontamination,bureau_publicite,commentaires
"1185, des Foreurs","2299001","7610-08-01-17124-06","","12223243","Terrain commercial"
"1075, 3e Avenue","2297678","7610-08-01-12049-06","","","Ancien garage"
"912, 3e Avenue","2297604","","","12343867","Station-service d√©saffect√©e"
"725, 3e Avenue","2297570","7610-08-01-12059-08","","","Zone industrielle"`;

            downloadFile("template-donnees-municipales.csv", template, "text/csv");
        });

        // Annuler
        cancelBtn.addEventListener("click", () => {
            parsedData = [];
            previewSection.style.display = "none";
            successMessage.style.display = "none";
            fileInput.value = "";
            uploadToFirebaseBtn.disabled = false;
        });

        // Drag & Drop
        dropZone.addEventListener("click", () => fileInput.click());

        dropZone.addEventListener("dragover", (event) => {
            event.preventDefault();
            dropZone.classList.add("drag-over");
        });

        dropZone.addEventListener("dragleave", () => {
            dropZone.classList.remove("drag-over");
        });

        dropZone.addEventListener("drop", (event) => {
            event.preventDefault();
            dropZone.classList.remove("drag-over");
            const [file] = event.dataTransfer.files;
            if (file) {
                handleFile(file);
            }
        });

        fileInput.addEventListener("change", (event) => {
            const [file] = event.target.files ?? [];
            if (file) {
                handleFile(file);
            }
        });
    </script>
</body>
</html>